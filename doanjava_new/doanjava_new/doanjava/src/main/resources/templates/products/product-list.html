<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security5"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">

<head>
    <title th:text="${title} ?: 'Products List'">Danh Sách Sản Phẩm</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">
</head>

<body>
<section layout:fragment="content">
    <h1>Danh Sách Sản Phẩm</h1>
    <div class="row mb-3" sec:authorize="!hasAuthority('ADMIN')">
        <div class="col-md-6">
            <!-- Dropdown for sorting products -->
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Sắp Xếp Sản Phẩm
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="sortDropdown">
                    <li><a class="dropdown-item " th:href="@{/products/sortByPriceAsc}">Giá Tăng Dần</a></li>
                    <li><a class="dropdown-item " th:href="@{/products/sortByPriceDesc}">Giá Giảm Dần</a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <!-- Form for selecting category -->
            <form th:action="@{/products/category}" method="get" class="d-flex">
                <select name="id" class="btn btn-secondary dropdown-toggle w-100" onchange="this.form.submit()">
                    <option value="">Chọn Loại Sản Phẩm</option>
                    <!-- Loop through categories from model -->
                    <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                </select>
            </form>
        </div>
    </div>

    <!-- Kiểm tra quyền và hiển thị nội dung tương ứng -->
    <div sec:authorize="hasAuthority('ADMIN')">
        <button class="btn btn-primary" sec:authorize="hasAnyAuthority('ADMIN')" >
            <a th:href="@{/products/add}" class="bi bi-plus text-white" style="text-decoration: none;">Thêm Sản Phẩm Mới</a>
        </button>
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Tên Sản Phẩm</th>
                <th>Giá</th>
                <th>Mô Tả Sản Phẩm</th>
                <th>Loại</th>
                <th>NSX</th>
                <th> Xuất Sứ</th>
                <th> Hình Ảnh</th>
                <th>Tùy Chỉnh</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product : ${products}">
                <td th:text="${product.id}"></td>
                <td th:text="${product.name}"></td>
                <td th:text="${product.price}"></td>
                <td th:text="${product.description}"></td>
                <td th:text="${product.category.name}"></td>
                <td th:text="${product.nsx}"></td>
                <td th:text="${product.xuatsu}"></td>
                <td>
                    <img th:src="@{${product.image}}" alt="Product Image" class="card-img-top product-image" style=" height: 100px;width: 150px;"/>
                </td>
                <td>
                    <!-- Hiển thị nút sửa và xóa chỉ dành cho người dùng ADMIN -->
                    <div sec:authorize="hasAuthority('ADMIN')">
                        <a th:href="@{/products/edit/{id}(id=${product.id})}" class="btn btn-success btn-sm">Sửa</a>
                        <a th:href="@{/products/delete/{id}(id=${product.id})}" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc không?')">Xóa</a>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Hiển thị cho người dùng không phải ADMIN -->
    <div sec:authorize="!hasAuthority('ADMIN')">
        <div class="container">
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <div class="col" th:each="product : ${products}">
                    <div class="card h-100">
                        <img th:src="@{${product.image}}" alt="Product Image" class="card-img-top product-image" style="height: 200px; width: 100%; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${product.name}">Tên Sản Phâm</h5>
                            <p class="card-text" th:text="${product.description}">Mô Tả Sản Phẩm</p>
                            <p class="card-text">Giá: <span th:text="${product.price}">Giá</span></p>
                            <p class="card-text">Loại: <span th:text="${product.category.name}">Loại</span></p>
                            <p class="card-text">NSX: <span th:text="${product.nsx}">Nhà Sản Xuất</span></p>
                            <p class="card-text">Xuất Sứ: <span th:text="${product.xuatsu}"> Xuất Sứ</span></p>
                        </div>
                        <div class="card-footer">
                            <!-- Nút thêm vào giỏ hàng, hiển thị cho tất cả người dùng đã xác thực -->
                            <form th:action="@{/cart/add}" method="post" sec:authorize="isAuthenticated()" class="mt-2">
                                <input type="number" name="quantity" min="1" value="1" class="form-control d-inline-block mb-2" style="width: 70px;">
                                <input type="hidden" th:value="${product.id}" name="productId"/>
                                <button type="submit" class="btn btn-warning btn-sm">Thêm Vào Giỏ</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });

            function performSearch() {
                const keyword = searchInput.value.trim();
                if (keyword !== '') {
                    // Gửi yêu cầu tìm kiếm đến backend
                    fetch(`/products/search?keyword=${encodeURIComponent(keyword)}`)
                        .then(response => response.json())
                        .then(products => {
                            console.log(products); // Xử lý dữ liệu sản phẩm được trả về từ backend
                            // Hiển thị kết quả tìm kiếm hoặc thực hiện hành động phù hợp
                        })
                        .catch(error => console.error('Error:', error));
                }
            }
        });
    </script>
</section>

</body>
</html>